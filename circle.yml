machine:
    environment:
        GOPATH: "$HOME/.go_workspace"
        WORKDIR:  "$GOPATH/src/github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME"
        PROTOC: "https://github.com/google/protobuf/releases/download/v3.0.0-beta-2/protoc-3.0.0-beta-2-linux-x86_64.zip"
        GO15VENDOREXPERIMENT: "1"

# Disable default dependency management.
# This prevents go dependencies to be automatically installed in order to
# ensure we are exclusively relying on vendored deps.
#
# https://discuss.circleci.com/t/overriding-go-inference-in-the-dependencies-phase/660
# https://robots.thoughtbot.com/configure-circleci-for-go
dependencies:
    pre:
        # Display debugging information in CI logs
        - go version
        - env

        # Force the wipe out of GOPATH to make sure we're not relying on
        # external dependencies.
        - rm -rf "$GOPATH"

    override:
        # protobuf
        - wget "$PROTOC"
        - unzip -o "$(basename $PROTOC)" -d "$HOME/bin"

        # GOPATH
        - mkdir -p "$(dirname $WORKDIR)"
        - ln -sf "$HOME/$CIRCLE_PROJECT_REPONAME" "$WORKDIR"

    post:
        - go get -u github.com/golang/lint/golint

test:
    override:
        - cd "$WORKDIR" && make all

        # Run generate *only* once all tests pass with checked-in generated
        # code.
        - cd "$WORKDIR" && make checkprotos
